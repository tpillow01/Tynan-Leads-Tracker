{% extends "base.html" %}
{% block title %}Lead Strategies — Dashboard{% endblock %}

{% block content %}
<section class="page-header">
  <h2>All Leads</h2>
  <div class="actions">
    <a class="btn" href="{{ url_for('add_lead') }}">+ Add Lead</a>
    <a class="btn secondary" href="{{ url_for('import_leads_view') }}">Import</a>
  </div>
</section>

<form method="get" action="{{ url_for('index') }}" class="card" style="margin-bottom:16px;">
  <div class="form-grid">
    <div class="form-field">
      <label for="q">Search</label>
      <input id="q" name="q" type="text" value="{{ q or '' }}" placeholder="Search company, notes, city, source, etc.">
    </div>

    <div class="form-field">
      <label for="rep">Rep</label>
      <select id="rep" name="rep">
        <option value="">All reps</option>
        {% for r in reps %}
          <option value="{{ r }}" {% if rep_filter == r %}selected{% endif %}>{{ r }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="form-field">
      <label for="quality">Quality</label>
      <select id="quality" name="quality">
        {% set qs = quality_filter or '' %}
        <option value=""  {% if qs=='' %}selected{% endif %}>All</option>
        <option value="good" {% if qs=='good' %}selected{% endif %}>Good</option>
        <option value="warm" {% if qs=='warm' %}selected{% endif %}>Warm</option>
        <option value="bad"  {% if qs=='bad' %}selected{% endif %}>Bad</option>
        <option value="unknown" {% if qs=='unknown' %}selected{% endif %}>Unknown</option>
      </select>
    </div>

    <div class="form-field">
      <label for="per_page">Rows per page</label>
      <select id="per_page" name="per_page">
        {% for n in [25,50,100,200] %}
          <option value="{{ n }}" {% if per_page == n %}selected{% endif %}>{{ n }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="form-field">
      <label for="view">View</label>
      <select id="view" name="view">
        <option value="cards" {% if view=='cards' %}selected{% endif %}>Cards</option>
        <option value="table" {% if view=='table' %}selected{% endif %}>Table</option>
      </select>
    </div>
  </div>

  <div class="form-actions">
    <button class="btn" type="submit">Apply</button>
    <a class="btn secondary" href="{{ url_for('index', view='cards') }}">Clear</a>
  </div>
</form>

{% if leads|length == 0 %}
  <div class="empty-state">
    <p>No leads match your filters.</p>
  </div>
{% else %}

  {% if view == 'table' %}
    <div class="table-wrap">
      <table class="data-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Rep</th>
            <th>Source</th>
            <th>Company</th>
            <th>City</th>
            <th>Quality</th>
            <th>Notes</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for lead in leads %}
          <tr>
            <td>{{ (lead.lead_date.strftime('%Y-%m-%d') if lead.lead_date else '') }}</td>
            <td>{{ lead.rep or '' }}</td>
            <td>{{ lead.source or '' }}</td>
            <td>{{ lead.company or '' }}</td>
            <td>{{ lead.city or '' }}</td>
            <td>
              {% set q = (lead.quality or 'unknown') %}
              <span class="badge {{ q }}">{{ q.title() }}</span>
            </td>
            <td style="max-width:360px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
              {{ lead.notes or '' }}
            </td>
            <td class="right">
              <a class="btn small" href="{{ url_for('lead_detail', lead_id=lead.id) }}">View</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <!-- Card Grid -->
    <div class="cards-grid">
      {% for lead in leads %}
        {% set q = (lead.quality or 'unknown') %}
        <div class="lead-card">
          <div class="top">
            <div>
              <div class="company">{{ lead.company or 'Unknown company' }}</div>
              <div class="meta">
                {{ (lead.lead_date.strftime('%Y-%m-%d') if lead.lead_date else '') }}
                • {{ lead.city or '—' }} • {{ lead.source or '—' }}
              </div>
            </div>
            <span class="badge {{ q }}">{{ q.title() }}</span>
          </div>
          <div class="notes">{{ lead.notes or 'No notes yet.' }}</div>
          <div class="actions">
            <a class="btn tiny" href="{{ url_for('lead_detail', lead_id=lead.id) }}">View</a>
            <form method="post" action="{{ url_for('set_quality', lead_id=lead.id, value='good') }}"><button class="btn tiny" type="submit">Good</button></form>
            <form method="post" action="{{ url_for('set_quality', lead_id=lead.id, value='warm') }}"><button class="btn tiny secondary" type="submit">Warm</button></form>
            <form method="post" action="{{ url_for('set_quality', lead_id=lead.id, value='bad') }}"><button class="btn tiny secondary" type="submit">Bad</button></form>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <div class="form-actions" style="justify-content:space-between; margin-top:12px;">
    <div class="muted">
      Page {{ pagination.page }} of {{ pagination.pages }} — {{ pagination.total }} leads
    </div>
    <div>
      {% if pagination.has_prev %}
        <a class="btn secondary" href="{{ url_for('index', q=q, rep=rep_filter, quality=quality_filter, per_page=per_page, view=view, sort=sort, dir=direction, page=pagination.prev_num) }}">← Prev</a>
      {% endif %}
      {% if pagination.has_next %}
        <a class="btn secondary" href="{{ url_for('index', q=q, rep=rep_filter, quality=quality_filter, per_page=per_page, view=view, sort=sort, dir=direction, page=pagination.next_num) }}">Next →</a>
      {% endif %}
    </div>
  </div>
{% endif %}
{% endblock %}
